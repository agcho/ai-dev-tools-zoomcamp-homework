version: '3.8'
services:
  # Full production-like single image (multi-stage Dockerfile)
  app:
    build: .
    image: coding-interview-app:latest
    ports:
      - "8000:8000"
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1

  # Dev API service: mounts local backend code and runs uvicorn
  api:
    image: python:3.12-slim
    working_dir: /app
    command: ["python", "-m", "uvicorn", "backend.app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    environment:
      - PYTHONUNBUFFERED=1
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app/backend:rw
      - ./backend/requirements.txt:/app/requirements.txt:ro
    # Install deps on container start
    entrypoint: ["/bin/sh", "-c", "python -m pip install --upgrade pip && python -m pip install -r /app/requirements.txt && exec \"$@\"", "sh"]

  # Dev frontend service: runs Vite dev server with HMR
  frontend:
    image: node:20-bullseye-slim
    working_dir: /app/frontend
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app/frontend:rw
    # Install deps on container start
    entrypoint: ["/bin/sh", "-c", "npm ci || npm install && exec \"$@\"", "sh"]
